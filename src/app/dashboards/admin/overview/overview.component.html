<div class="dashboard-container">
  <div class="dashboard-header">
    <h1>Dashboard Overview</h1>
    <div class="date-range-selector">
      <button
        mat-button
        [class.active]="dateRange === 'week'"
        (click)="onDateRangeChange('week')"
        [disabled]="loading"
      >
        This Week
      </button>
      <button
        mat-button
        [class.active]="dateRange === 'month'"
        (click)="onDateRangeChange('month')"
        [disabled]="loading"
      >
        This Month
      </button>
      <button
        mat-button
        [class.active]="dateRange === 'year'"
        (click)="onDateRangeChange('year')"
        [disabled]="loading"
      >
        This Year
      </button>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid" *ngIf="!loading; else loadingTemplate">
    <mat-card class="stat-card">
      <mat-card-header>
        <mat-card-title>Total Articles</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="stat-value">{{ formatNumber(stats.totalArticles) }}</div>
        <div class="stat-subtitle">
          <span
            class="trend"
            [class.positive]="stats.articlesThisMonth >= stats.articlesLastMonth"
            [class.negative]="stats.articlesThisMonth < stats.articlesLastMonth"
          >
            <mat-icon>trending_up</mat-icon>
            {{ stats.articlesThisMonth - stats.articlesLastMonth }} more than last month
          </span>
          <span class="trend negative" *ngIf="stats.articlesThisMonth < stats.articlesLastMonth">
            <mat-icon>trending_down</mat-icon>
            {{ stats.articlesLastMonth - stats.articlesThisMonth }} less than last month
          </span>
          <span class="trend" *ngIf="stats.articlesThisMonth === stats.articlesLastMonth">
            <mat-icon>{{
              stats.articlesThisMonth >= stats.articlesLastMonth ? 'trending_up' : 'trending_down'
            }}</mat-icon>
            {{ Math.abs(stats.articlesThisMonth - stats.articlesLastMonth) }}
            {{ stats.articlesThisMonth >= stats.articlesLastMonth ? 'more' : 'fewer' }} this month
          </span>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-header>
        <mat-card-title>Total Authors</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="stat-value">{{ stats.totalAuthors | number }}</div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-header>
        <mat-card-title>Total Comments</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="stat-value">{{ stats.totalComments | number }}</div>
      </mat-card-content>
    </mat-card>

    <mat-card class="stat-card">
      <mat-card-header>
        <mat-card-title>Total Views</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="stat-value">{{ stats.totalViews | number }}</div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Charts Row -->
  <div class="charts-row" *ngIf="!loading">
    <!-- Articles by Month -->
    <mat-card class="chart-card">
      <mat-card-header>
        <mat-card-title>Articles Published</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="chart-container" *ngIf="!chartsLoading; else chartLoading">
          <canvas baseChart [type]="barChartType" [data]="barChartData" [options]="barChartOptions">
          </canvas>
        </div>
        <ng-template #chartLoading>
          <div class="chart-loading">
            <mat-spinner diameter="40"></mat-spinner>
          </div>
        </ng-template>
      </mat-card-content>
    </mat-card>

    <!-- Views Over Time -->
    <mat-card class="chart-card">
      <mat-card-header>
        <mat-card-title>Views Over Time</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="chart-container" *ngIf="!chartsLoading; else chartLoading">
          <canvas
            baseChart
            [type]="lineChartType"
            [data]="lineChartData"
            [options]="lineChartOptions"
          >
          </canvas>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Content Row -->
  <div class="content-row" *ngIf="!loading">
    <!-- Top Viewed Articles -->
    <mat-card class="content-card">
      <mat-card-header>
        <mat-card-title>Top Viewed Articles</mat-card-title>
      </mat-card-header>
      <mat-list>
        <mat-list-item *ngFor="let article of topViewedArticles" class="list-item">
          <div class="article-title" [matTooltip]="article.title || 'Untitled Article'">
            {{ article.title || 'Untitled Article' | slice: 0 : 50
            }}{{ (article.title || '').length > 50 ? '...' : '' }}
          </div>
          <div class="article-meta">
            <span class="views" matTooltip="Views">
              <mat-icon>visibility</mat-icon> {{ formatNumber(article.views || 0) }}
            </span>
            <span class="comments" matTooltip="Comments">
              <mat-icon>comment</mat-icon> {{ formatNumber(article.commentCount || 0) }}
            </span>
          </div>
        </mat-list-item>
        <mat-list-item *ngIf="!topViewedArticles?.length" class="no-data">
          No articles found
        </mat-list-item>
      </mat-list>
    </mat-card>

    <!-- Recent Comments -->
    <mat-card class="content-card">
      <mat-card-header>
        <mat-card-title>Recent Comments</mat-card-title>
      </mat-card-header>
      <div class="comment-list">
        <div *ngIf="!recentComments?.length" class="no-comments">
          <p>No recent comments</p>
        </div>
        <div *ngFor="let comment of recentComments" class="comment-item">
          <div class="comment-header">
            <span class="comment-author">{{ comment.author || 'Anonymous' }}</span>
            <span class="comment-date">{{ formatDate(comment.date) }}</span>
          </div>
          <div class="comment-article" matTooltip="View article">
            <mat-icon>article</mat-icon> {{ comment.articleTitle || 'Untitled Article' }}
          </div>
          <div class="comment-text" matTooltip="{{ comment.text }}">
            {{ comment.text | slice: 0 : 100 }}{{ comment.text.length > 100 ? '...' : '' }}
          </div>
        </div>
      </div>
    </mat-card>
  </div>

  <!-- Popular Tags -->
  <mat-card class="tags-section" *ngIf="!loading">
    <mat-card-header>
      <mat-card-title>Popular Tags</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="tags-container">
        <mat-chip-option
          *ngFor="let tag of popularTags"
          [style.fontSize.px]="12 + tag.count * 0.5"
          [matTooltip]="tag.count + ' articles'"
          [routerLink]="['/tags', tag.id]"
        >
          {{ tag.name }} ({{ tag.count }})
        </mat-chip-option>
        <div *ngIf="!popularTags.length" class="no-data">No tags found</div>
      </div>
    </mat-card-content>
  </mat-card>
</div>

<!-- Loading Templates -->
<ng-template #loadingTemplate>
  <div class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Loading dashboard data...</p>
  </div>
</ng-template>

<!-- No Data Template -->
<ng-template #noDataTemplate>
  <div class="no-data">
    <mat-icon>info</mat-icon>
    <p>No data available</p>
  </div>
</ng-template>

<ng-template #chartLoading>
  <div class="chart-loading">
    <mat-spinner [diameter]="40"></mat-spinner>
  </div>
</ng-template>
